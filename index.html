<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>仕入れ値計算アプリ（売上比利益率）</title>
<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Meiryo, sans-serif;
  max-width: 480px; margin: 2rem auto; padding: 1rem;
  border: 1px solid #ddd; border-radius: 12px;
}
h1 { font-size: 1.2rem; margin: 0 0 .75rem; }
label { display:block; margin-top: .9rem; font-weight:600; }
input, select, button {
  width:100%; padding:.55rem .65rem; box-sizing:border-box;
  margin-top:.4rem; border:1px solid #ccc; border-radius:8px;
}
button { cursor:pointer; }
.row { display:flex; gap:.6rem; }
.row > div { flex:1; }
.hint { font-size:.8rem; color:#777; margin-top:.25rem; }
#result { margin-top:1.2rem; font-weight:700; white-space: normal; border-top:1px dashed #ddd; padding-top:1rem; }
.hidden { display:none; }

/* Mode toggle */
.mode-toggle { display:flex; gap:.6rem; margin-bottom:.6rem; }
.mode-btn {
  flex:1; padding:.55rem .65rem; border:1px solid #ddd;
  border-radius:9999px; background:#fafafa; font-weight:700;
  text-align:center; transition:all .15s ease;
}
.mode-btn:hover { filter:brightness(0.98); }
.mode-btn.retail.active { background:#ffe9e9; border-color:#ffbcbc; color:#9a2a2a; }
.mode-btn.wholesale.active { background:#eaf3ff; border-color:#bfd8ff; color:#244b8a; }
</style>
</head>
<body>
<h1>仕入れ値計算アプリ（売上比利益率）</h1>

<div aria-label="モード切替" class="mode-toggle" role="tablist">
  <button class="mode-btn retail active" id="btnRetail">小売（内税）</button>
  <button class="mode-btn wholesale" id="btnWholesale">業販（外税）</button>
</div>

<!-- ▼ 小売（そのまま） -->
<div id="currencySection">
  <label>売価通貨（小売のみ）
    <select id="currency">
      <option value="JPY">JPY（円）</option>
      <option value="USD">USD（米ドル）</option>
    </select>
  </label>
  <label id="fxLabel" style="display:none;">
    為替レート（1 USD = JPY）
    <input id="fxRate" readonly type="number"/>
    <div class="hint">※自動取得（失敗時は手入力）</div>
  </label>
</div>

<label><span id="salePriceLabel">売価（表示通貨）</span>
  <input id="salePrice" placeholder="例: 65000（JPY）/ 500（USD）" type="number"/>
</label>

<div id="retailExtras">
  <label>送料(円・原価に加算)
    <input id="shippingYen" type="number" value="700"/>
  </label>
  <label>出品代行手数料(円・原価に加算)
    <input id="listingFeeYen" type="number" value="1320"/>
    <div class="hint">※売価通貨がUSDでも円で計上</div>
  </label>
</div>

<!-- ▼ 業販（外税）＋内税モード -->
<div class="hidden" id="wholesaleExtras" style="display:none;">
  <label>その他費用（円）
    <input id="otherCostYen" type="number" value="0"/>
  </label>
  <label style="display:flex; gap:.45rem; align-items:center; margin-top:.6rem;">
    <input id="wholesaleTaxIn" type="checkbox" style="width:auto; margin-top:0;"/>
    業販を内税で計算する（売価は税抜を入力）
  </label>
</div>

<div class="row">
  <div>
    <label>プラットフォーム手数料（%）
      <input id="platformFee" type="number" value="10"/>
    </label>
  </div>
  <div>
    <label>落札手数料（%）
      <input id="auctionFeeRate" type="number" value="5"/>
    </label>
  </div>
</div>

<div class="row">
  <div>
    <label>仕入消費税（%）
      <input id="tax" type="number" value="10"/>
    </label>
  </div>
  <div>
    <label>目標利益率（%）<small>（売上比）</small>
      <input id="margin" type="number" value="20"/>
    </label>
  </div>
</div>

<button id="calcBtn">仕入れ値（税抜）を計算</button>

<div id="result">仕入れ値 (税抜) ≒ ¥0<br>利益額 ≒ ¥0</div>

<script>
let currentMode = 'retail';

// モードごとの状態を保持
const modeState = {
  retail: {
    initialized: false,
    platformFee: 10,
    auctionFee: 5,
    margin: 20
  },
  wholesale: {
    initialized: false,
    platformFee: 3,
    auctionFee: 5,
    margin: 10,
    taxIn: false,
    otherCost: 0
  }
};

function yen(n){ return '¥' + Math.round(n).toLocaleString('ja-JP'); }

function applyModeValues() {
  const s = modeState[currentMode];
  document.getElementById('platformFee').value = s.platformFee;
  document.getElementById('auctionFeeRate').value = s.auctionFee;
  document.getElementById('margin').value = s.margin;
  if (currentMode === 'wholesale') {
    document.getElementById('wholesaleTaxIn').checked = !!s.taxIn;
    document.getElementById('otherCostYen').value = typeof s.otherCost === 'number' ? s.otherCost : 0;
  }
}

function saveCurrentInputsToMode() {
  const s = modeState[currentMode];
  s.platformFee = parseFloat(document.getElementById('platformFee').value) || 0;
  s.auctionFee  = parseFloat(document.getElementById('auctionFeeRate').value) || 0;
  s.margin      = parseFloat(document.getElementById('margin').value) || 0;
  if (currentMode === 'wholesale') {
    s.taxIn    = document.getElementById('wholesaleTaxIn').checked;
    s.otherCost = parseFloat(document.getElementById('otherCostYen').value) || 0;
  }
  s.initialized = true;
}

function syncUI() {
  const isRetail = currentMode === 'retail';
  document.getElementById('currencySection').style.display = isRetail ? 'block' : 'none';
  document.getElementById('retailExtras').style.display    = isRetail ? 'block' : 'none';
  document.getElementById('wholesaleExtras').style.display = isRetail ? 'none'  : 'block';

  document.getElementById('salePriceLabel').innerText = isRetail ? '売価（表示通貨）' : '売価（円）';

  document.getElementById('btnRetail').classList.toggle('active', isRetail);
  document.getElementById('btnWholesale').classList.toggle('active', !isRetail);

  if (!modeState[currentMode].initialized) {
    applyModeValues();
    modeState[currentMode].initialized = true;
  } else {
    applyModeValues();
  }

  if (isRetail) {
    const cur = document.getElementById('currency').value;
    document.getElementById('fxLabel').style.display = (cur === 'USD') ? 'block' : 'none';
  } else {
    document.getElementById('fxLabel').style.display = 'none';
  }
}

document.getElementById('btnRetail').addEventListener('click', () => {
  saveCurrentInputsToMode();
  currentMode = 'retail';
  syncUI();
});
document.getElementById('btnWholesale').addEventListener('click', () => {
  saveCurrentInputsToMode();
  currentMode = 'wholesale';
  syncUI();
});

// 入力のたびに保存
['platformFee','auctionFeeRate','margin','wholesaleTaxIn','otherCostYen'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', () => {
    saveCurrentInputsToMode();
  });
});

// 為替（小売のみ）
async function fetchFx() {
  try {
    const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
    const json = await res.json();
    const rate = json?.rates?.JPY;
    if (rate) document.getElementById('fxRate').value = Number(rate).toFixed(2);
  } catch(e){}
}
document.getElementById('currency').addEventListener('change', () => {
  const cur = document.getElementById('currency').value;
  document.getElementById('fxLabel').style.display = (cur === 'USD' && currentMode === 'retail') ? 'block' : 'none';
  if (cur === 'USD' && !document.getElementById('fxRate').value) fetchFx();
});

syncUI();

/* ===== 計算ボタン ===== */
document.getElementById('calcBtn').addEventListener('click', () => {
  const isRetail = currentMode === 'retail';

  const saleInput = parseFloat(document.getElementById('salePrice').value) || 0;
  const pf = (parseFloat(document.getElementById('platformFee').value) || 0) / 100;
  const auction = (parseFloat(document.getElementById('auctionFeeRate').value) || 0) / 100;
  const tax = (parseFloat(document.getElementById('tax').value) || 0) / 100;
  const margin = (parseFloat(document.getElementById('margin').value) || 0) / 100;

  /* ===== 小売（元ロジック） ===== */
  if (isRetail) {
    let saleJPY = saleInput;
    const cur = document.getElementById('currency').value;
    if (cur === 'USD') {
      const fx = parseFloat(document.getElementById('fxRate').value) || 0;
      saleJPY = saleInput * fx;
    }

    const shipping = parseFloat(document.getElementById('shippingYen').value) || 0;
    const listing  = parseFloat(document.getElementById('listingFeeYen').value) || 0;

    const netSale = saleJPY * (1 - pf);
    const targetCost = netSale * (1 - margin);
    const available = Math.max(targetCost - shipping - listing, 0);
    const preTax = available / (1 + tax + auction);
    const auctionYen = preTax * auction;
    const totalCost = preTax * (1 + tax) + auctionYen + shipping + listing;
    const profit = netSale - totalCost;

    document.getElementById('result').innerHTML =
      '仕入れ値 (税抜) ≒ ' + yen(preTax) + '<br>' +
      '利益額 ≒ ' + yen(profit);

    saveCurrentInputsToMode();
    return;
  }

  /* ===== 業販 ===== */
  const other = parseFloat(document.getElementById('otherCostYen').value) || 0;
  const taxInMode = document.getElementById('wholesaleTaxIn').checked;

  if (taxInMode) {
    // ここが今回の「内税業販」ロジック
    // 1. 売価は税抜で入力される
    const saleEx  = saleInput;       // 例: 100000
    const saleInc = saleEx * 1.10;   // 税込売上 110000
    // 2. プラットフォーム手数料は税抜売価に対して
    const pfYen = saleEx * pf;       // 100000 * 0.03 = 3000
    // 3. 利益は税込売上に対して
    const targetProfit = saleInc * margin;   // 110000 * 0.1 = 11000

    // 税込売上から、利益・PF・その他費用を引いて、
    // 残りを「入札(税込) ＋ その5%」で割り戻す
    const availableForBidAndAuction =
      saleInc - targetProfit - pfYen - other;

    // この残りが B + B*auction なので B = 残り / (1+auction)
    const bidInc = availableForBidAndAuction / (1 + auction);   // 税込で入札できる最大額
    const bidEx  = bidInc / 1.10;                                // 表示用に税抜へ
    const auctionYen = bidInc * auction;

    const totalCost =
      pfYen + other + bidInc + auctionYen;

    const profit = saleInc - totalCost;

    document.getElementById('result').innerHTML =
      '仕入れ値 (税抜) ≒ ' + yen(bidEx) + '<br>' +
      '仕入れ値 (税込) ≒ ' + yen(bidInc) + '<br>' +
      '利益額 ≒ ' + yen(profit);

  } else {
    // これまでの業販（外税）計算
    const netSale = saleInput * (1 - pf);
    const targetCost = netSale * (1 - margin);
    const available = Math.max(targetCost - other, 0);
    const preTax = available / (1 + auction);
    const auctionYen = preTax * auction;
    const totalCost = preTax + auctionYen + other;
    const profit = netSale - totalCost;

    document.getElementById('result').innerHTML =
      '仕入れ値 (税抜) ≒ ' + yen(preTax) + '<br>' +
      '利益額 ≒ ' + yen(profit);
  }

  saveCurrentInputsToMode();
});
</script>
</body>
</html>
